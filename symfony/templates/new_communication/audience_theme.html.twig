{% block audience_widget %}
    {% import 'macros.html.twig' as macros %}

    {{ form_start(form) }}

    <div class="h3">
        {{ 'audience.audience'|trans }}
    </div>
    <p>{{ 'audience.audience_help'|trans }}</p>
    <br/>

    {# -------------------------------------------------------------------------------- #}
    {# Manual selection #}
    {# -------------------------------------------------------------------------------- #}

    {% if app.user.structures|length > 1 %}
        <div class="h4">
            {{ 'audience.manual_selection'|trans }}
        </div>
    {% endif %}

    {{ form_label(form.volunteers) }}
    {{ form_widget(form.volunteers, {
        'attr': {
            'class': 'flexdatalist',
            'multiple': "multiple",
            'placeholder': 'base.search.placeholder'|trans,
            'data-data': volunteers_data|json_encode,
            'data-url': path('audience_search_volunteer'),
            'data-search-disabled': true,
            'data-min-length': 1,
            'data-visible-properties': '["human"]',
            'data-no-results-text': 'base.search.no_results'|trans,
            'data-focus-first-result': true,
            'data-selection-required': true,
            'data-text-property': "human",
            'data-value-property': "id",
        }
    }) }}

    {{ form_row(form.nivols) }}
    <br/>

    {# -------------------------------------------------------------------------------- #}
    {# Structure tree #}
    {# -------------------------------------------------------------------------------- #}
    {{ form_row(form.structures_global) }}
    {{ form_row(form.structures_local) }}

    {% if app.user.structures|length > 1 %}

        <div class="h4">
            {{ 'audience.structures'|trans }}
        </div>

        {# All structure ticks, in the tree view #}
        {% macro renderSlider(form, global, local, hierarchy, information, current) %}

            {% set has_children = hierarchy[current]|length %}

            {# Slider header #}
            <div>
                <label class="switch">
                    <input id="global-structure-{{ current }}"
                           type="checkbox"
                           class="toggle-to-text"
                           {% if current in global %}checked{% endif %}
                           data-field="#{{ form.structures_global.vars.id }}"
                           data-id="{{ current }}"/>
                    <span class="slider"></span>
                </label>
                {% if has_children %}
                    <a data-toggle="collapse" href="#container-children-{{ current }}">
                        <label for="global-structure-{{ current }}">
                            {{ information[current].name }} ({{ information[current].global_count }})
                        </label>
                    </a>
                {% else %}
                    <label for="global-structure-{{ current }}">
                        {{ information[current].name }} ({{ information[current].global_count }})
                    </label>
                {% endif %}
            </div>

            {# Slider body #}
            {% if has_children %}
                <div id="container-children-{{ current }}" class="collapse">
                    <div class="card card-body">
                        <div>
                            <label class="switch">
                                <input id="local-structure-{{ current }}"
                                       type="checkbox"
                                       class="toggle-to-text"
                                       {% if current in local %}checked{% endif %}
                                       data-field="#{{ form.structures_local.vars.id }}"
                                       data-id="{{ current }}"/>
                                <span class="slider"></span>
                            </label>
                            <label for="local-structure-{{ current }}">
                                {{ information[current].name }} ({{ information[current].local_count }})
                            </label>
                        </div>
                        {% for child in hierarchy[current] %}
                            {{ _self.renderSlider(form, global, local, hierarchy, information, child) }}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endmacro %}

        {% for structure_id in structures_roots %}
            {{ _self.renderSlider(form, form.structures_global.vars.data|split(','), form.structures_local.vars.data|split(','), structures_hierarchy, structures_information, structure_id) }}
        {% endfor %}

        <br/>
    {% endif %}

    {# -------------------------------------------------------------------------------- #}
    {# Badges #}
    {# -------------------------------------------------------------------------------- #}

    {% if app.user.structures|length > 1 %}
        <div class="h4">
            {{ 'audience.badges'|trans }}
        </div>
    {% endif %}

    {# Trigger everyone discarding badges #}
    {{ form_row(form.badges_all) }}

    {# Main badges #}
    <div class="row">

        {% set badges_ticked = form.badges_ticked.vars.data|split(',') %}

        {% for badge in badges_public %}
            <div class="col-md-3">
                <label class="switch">
                    <input id="badge-{{ badge.id }}"
                           type="checkbox"
                           class="toggle-to-text"
                           {% if badge.id in badges_ticked %}checked{% endif %}
                           data-field="#{{ form.badges_ticked.vars.id }}"
                           data-id="{{ badge.id }}"/>
                    <span class="slider"></span>
                </label>
                <label for="badge-{{ badge.id }}">
                    {{ badge.name }}
                </label>

            </div>
        {% endfor %}
    </div>

    <br/>

    {# Other badges search #}
    {{ form_row(form.badges_searched, {
        'attr': {
            'class': 'flexdatalist',
            'multiple': "multiple",
            'placeholder': 'base.search.placeholder'|trans,
            'data-url': path('audience_search_badge'),
            'data-data': badges_searched|json_encode,
            'data-search-disabled': true,
            'data-min-length': 1,
            'data-visible-properties': '["name"]',
            'data-no-results-text': 'base.search.no_results'|trans,
            'data-focus-first-result': true,
            'data-selection-required': true,
            'data-text-property': "name",
            'data-value-property': "id",
        }
    }) }}

    {# -------------------------------------------------------------------------------- #}
    {# Summary #}
    {# -------------------------------------------------------------------------------- #}

    <div class="h4">
        {{ 'audience.classification.title'|trans }}
    </div>

    {{ include('new_communication/classification.html.twig', {
        classification: classification,
    }) }}

    {% set body %}

        sss

    {% endset %}

    {{ macros.modal('problems-modal', 'audience.problems.title'|trans, body) }}

    {# -------------------------------------------------------------------------------- #}
    {# Javscript #}
    {# -------------------------------------------------------------------------------- #}

    <script type="text/javascript">

        {# Filling up backend fields when ticking structures/badges #}
        $('.toggle-to-text').click(function () {
            var tick = $(this);
            var input = $(tick.data('field'));
            var list = input.val().split(',');
            if (tick.is(':checked')) {
                if (!list.includes(tick.data('id'))) {
                    list.push(tick.data('id'));
                }
            } else if (!tick.is(':checked')) {
                var index = list.indexOf(tick.data('id').toString());
                if (index >= 0) {
                    list.splice(index, 1);
                }
            }
            input.val(list.join(','));
        });

        {# Opening the list of problems #}
        $('#open-problems').click(function (e) {
            e.preventDefault();

            $('#problems-modal').modal();


        });

    </script>

    {{ form_end(form) }}

{% endblock %}